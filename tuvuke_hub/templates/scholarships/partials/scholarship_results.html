<!-- Scholarship search results partial template for HTMX -->

<!-- Search Statistics -->
<div class="search-stats">
    <div class="stats-text">
        {% if search_stats.total_found %}
            Found <strong>{{ search_stats.total_found }}</strong> scholarship{{ search_stats.total_found|pluralize }}
            {% if search_stats.search_query %}for "<em>{{ search_stats.search_query }}</em>"{% endif %}
        {% else %}
            No scholarships found
            {% if search_stats.search_query %}for "<em>{{ search_stats.search_query }}</em>"{% endif %}
        {% endif %}
    </div>
    <div class="stats-badges">
        {% if search_stats.filters_applied %}
            <span class="stats-badge">Filtered</span>
        {% endif %}
        <span class="stats-badge">Page {{ search_stats.current_page }} of {{ search_stats.total_pages }}</span>
    </div>
</div>

<!-- Scholarship Results Grid -->
{% if scholarships_with_scores %}
<div class="scholarship-grid">
    {% for item in scholarships_with_scores %}
    {% with scholarship=item.scholarship match_score=item.match_score eligibility_status=item.eligibility_status %}
    <div class="scholarship-card" 
         hx-get="{% url 'scholarships:htmx_scholarship_quick_view' %}?id={{ scholarship.id }}"
         hx-target="#quickViewModal"
         hx-trigger="click">
        
        <div class="card-header">
            <div class="card-provider">{{ scholarship.provider.name }}</div>
            <h3 class="card-title">{{ scholarship.title }}</h3>
            
            <div class="card-meta">
                <div class="amount-badge">
                    KES {{ scholarship.amount_per_beneficiary|floatformat:0 }}
                </div>
                <div class="deadline-badge {% if scholarship.days_until_deadline <= 7 %}deadline-urgent{% elif scholarship.days_until_deadline <= 30 %}deadline-soon{% else %}deadline-normal{% endif %}">
                    <i class="fas fa-clock"></i> 
                    {% if scholarship.days_until_deadline %}
                        {{ scholarship.days_until_deadline }} day{{ scholarship.days_until_deadline|pluralize }} left
                    {% else %}
                        Deadline passed
                    {% endif %}
                </div>
            </div>
            
            <!-- Match Score (only for authenticated users) -->
            {% if user_student and match_score is not None %}
            <div class="match-score {% if match_score >= 80 %}high{% elif match_score >= 60 %}medium{% else %}low{% endif %}">
                {{ match_score|floatformat:0 }}% Match
            </div>
            {% elif scholarship.is_featured %}
            <div class="match-score high">
                <i class="fas fa-star"></i> Featured
            </div>
            {% endif %}
        </div>
        
        <div class="card-body">
            <p class="card-description">{{ scholarship.description|truncatewords:25 }}</p>
            
            <div class="card-tags">
                <span class="tag">{{ scholarship.get_scholarship_type_display }}</span>
                
                <!-- Education Level Tags -->
                {% if scholarship.target_education_levels %}
                    {% for level in scholarship.target_education_levels|slice:":2" %}
                    <span class="tag">{{ level|title }}</span>
                    {% endfor %}
                {% endif %}
                
                <!-- County Tags -->
                {% if scholarship.target_counties.exists %}
                    {% for county in scholarship.target_counties.all|slice:":2" %}
                    <span class="tag">{{ county.get_name_display }}</span>
                    {% endfor %}
                    {% if scholarship.target_counties.count > 2 %}
                    <span class="tag">+{{ scholarship.target_counties.count|add:"-2" }} more</span>
                    {% endif %}
                {% else %}
                    <span class="tag">All Counties</span>
                {% endif %}
                
                <!-- Special Requirements -->
                {% if scholarship.for_orphans_only %}
                <span class="tag special">Orphans Only</span>
                {% endif %}
                {% if scholarship.for_disabled_only %}
                <span class="tag special">Disability Support</span>
                {% endif %}
                {% if scholarship.for_females_only %}
                <span class="tag special">Female Only</span>
                {% endif %}
                {% if scholarship.for_males_only %}
                <span class="tag special">Male Only</span>
                {% endif %}
            </div>
            
            <!-- Additional Metadata -->
            <div class="card-footer-info">
                <div class="info-row">
                    <small class="text-muted">
                        <i class="fas fa-users"></i> {{ scholarship.number_of_awards }} award{{ scholarship.number_of_awards|pluralize }} available
                    </small>
                    {% if scholarship.renewable %}
                    <small class="text-success">
                        <i class="fas fa-sync"></i> Renewable
                    </small>
                    {% endif %}
                </div>
                
                {% if scholarship.minimum_gpa or scholarship.minimum_percentage %}
                <div class="info-row">
                    <small class="text-info">
                        <i class="fas fa-chart-line"></i>
                        {% if scholarship.minimum_gpa %}
                            Min GPA: {{ scholarship.minimum_gpa }}
                        {% elif scholarship.minimum_percentage %}
                            Min Grade: {{ scholarship.minimum_percentage }}%
                        {% endif %}
                    </small>
                </div>
                {% endif %}
                
                {% if scholarship.maximum_family_income %}
                <div class="info-row">
                    <small class="text-warning">
                        <i class="fas fa-money-bill"></i>
                        Max Family Income: KES {{ scholarship.maximum_family_income|floatformat:0 }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endwith %}
    {% endfor %}
</div>

<!-- Pagination -->
{% if search_stats.total_pages > 1 %}
<div class="pagination-container">
    <div class="pagination">
        {% if page_obj.has_previous %}
            <button hx-get="{% url 'scholarships:htmx_scholarship_search' %}?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}"
                    hx-target="#search-results">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        {% else %}
            <button disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        {% endif %}
        
        <!-- Page numbers -->
        {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
                <button class="active">{{ num }}</button>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <button hx-get="{% url 'scholarships:htmx_scholarship_search' %}?page={{ num }}&{{ request.GET.urlencode }}"
                        hx-target="#search-results">
                    {{ num }}
                </button>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
            <button hx-get="{% url 'scholarships:htmx_scholarship_search' %}?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}"
                    hx-target="#search-results">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        {% else %}
            <button disabled>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<!-- No Results -->
<div class="no-results">
    <i class="fas fa-search"></i>
    <h3>No Scholarships Found</h3>
    {% if search_stats.search_query or search_stats.filters_applied %}
    <p>Try adjusting your search terms or filters to find more opportunities.</p>
    <button class="btn btn-outline-primary" onclick="resetSearch()">
        <i class="fas fa-undo"></i> Reset Search
    </button>
    {% else %}
    <p>There are currently no active scholarships available. Please check back later!</p>
    {% endif %}
</div>
{% endif %}

<!-- Additional CSS for new elements -->
<style>
.card-footer-info {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #f1f3f4;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.info-row:last-child {
    margin-bottom: 0;
}

.tag.special {
    background: #e8f4fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.deadline-urgent {
    background: #ffebee !important;
    color: #c62828 !important;
}

.deadline-soon {
    background: #fff3e0 !important;
    color: #ef6c00 !important;
}

.deadline-normal {
    background: #e8f5e8 !important;
    color: #2e7d32 !important;
}

.scholarship-card {
    position: relative;
    overflow: hidden;
}

.scholarship-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #007bff, #28a745);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.scholarship-card:hover::before {
    transform: scaleX(1);
}

@media (max-width: 768px) {
    .card-meta {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }
    
    .info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .pagination {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .pagination button {
        padding: 8px 12px;
        font-size: 14px;
    }
}
</style>

<script>
// Reset search function
function resetSearch() {
    const form = document.getElementById('searchForm');
    if (form) {
        // Clear all inputs
        form.querySelectorAll('input[type="text"], input[type="search"]').forEach(input => {
            input.value = '';
        });
        
        // Reset all selects
        form.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
        });
        
        // Trigger search
        htmx.trigger(form, 'submit');
    }
}

// Add smooth scrolling to pagination
document.querySelectorAll('.pagination button[hx-get]').forEach(button => {
    button.addEventListener('click', () => {
        setTimeout(() => {
            document.getElementById('search-results').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
    });
});
</script>
